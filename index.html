<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<title>æ´»çš„å’Œå£°ç”Ÿæˆå™¨ Â· å¯ç‹¬å¬</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://unpkg.com/tone@14.8.49/build/Tone.js"></script>

<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  background:#111; color:#eee;
  padding:20px;
}
button, select {
  width:100%;
  padding:12px;
  margin:8px 0;
  font-size:16px;
}
h1 { font-size:22px; }
p { color:#aaa; }
</style>
</head>

<body>

<h1>ğŸ¶ æ´»çš„å’Œå£°ç”Ÿæˆå™¨</h1>
<p>éå¹³è¡Œ Â· ä¸å˜é€Ÿ Â· å¯ç‹¬å¬å’Œå£°</p >

<button onclick="startRec()">å¼€å§‹å½•éŸ³</button>
<button onclick="stopRec()">åœæ­¢å¹¶ç”Ÿæˆ</button>

<select id="mode">
  <option value="both">ä¸»æ—‹å¾‹ + å’Œå£°</option>
  <option value="harmony">åªå¬å’Œå£°</option>
  <option value="original">åªå¬åŸæ—‹å¾‹</option>
</select>

<script>
let recorder, chunks=[];
let originalPlayer, harmonyShift;

async function startRec(){
  await Tone.start();
  chunks = [];
  const stream = await navigator.mediaDevices.getUserMedia({audio:true});
  recorder = new MediaRecorder(stream);
  recorder.ondataavailable = e => chunks.push(e.data);
  recorder.start();
}

async function stopRec(){
  recorder.stop();
  recorder.onstop = async () => {

    const blob = new Blob(chunks,{type:'audio/webm'});
    const url = URL.createObjectURL(blob);

    // ğŸ¤ åŸæ—‹å¾‹
    originalPlayer = new Tone.Player({
      url,
      playbackRate: 1  // ğŸ”’ é”æ­»é€Ÿåº¦
    }).toDestination();

    // ğŸ¶ å’Œå£°ï¼ˆåªå˜è°ƒï¼Œä¸å˜é€Ÿï¼‰
    harmonyShift = new Tone.PitchShift({
      pitch: 0,
      windowSize: 0.12,
      delayTime: 0.05,
      feedback: 0
    }).toDestination();

    originalPlayer.connect(harmonyShift);

    applyMode();

    // ğŸ¼ â€œæ´»â€çš„å’Œå£°è¡Œä¸º
    let last = null;
    setInterval(()=>{
      const choices = [3,4,7,0]; // 0 = åœç•™
      let next = choices[Math.floor(Math.random()*choices.length)];

      if (next === last) next = 0;
      harmonyShift.pitch = next;
      last = next;
    }, 900);

    originalPlayer.start();
  };
}

// ğŸ§ ç›‘å¬æ¨¡å¼åˆ‡æ¢
function applyMode(){
  const mode = document.getElementById('mode').value;

  if(!originalPlayer || !harmonyShift) return;

  if(mode === "both"){
    originalPlayer.volume.value = 0;
    harmonyShift.volume.value = -6;
  }

  if(mode === "harmony"){
    originalPlayer.volume.value = -Infinity;
    harmonyShift.volume.value = 0;
  }

  if(mode === "original"){
    originalPlayer.volume.value = 0;
    harmonyShift.volume.value = -Infinity;
  }
}

document.getElementById("mode").addEventListener("change", applyMode);
</script>

</body>
</html>
